<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞ –¥–ª—è Genially</title>
  <style>
    :root{
      --bg1:#070a12;
      --bg2:#0b1224;
      --card:rgba(16,24,42,.55);
      --border:rgba(255,255,255,.12);
      --text:#e8eefc;
      --muted:#a9b6d6;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;color:var(--text);background:linear-gradient(120deg,var(--bg1),var(--bg2) 60%,var(--bg1))}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      border:1px solid var(--border);border-radius:16px;background:var(--card);
      backdrop-filter: blur(10px);padding:14px 16px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start
    }
    h1{margin:0;font-size:16px}
    .sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35}
    .grid{display:grid;grid-template-columns:460px 1fr;gap:16px;margin-top:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--border);border-radius:16px;background:var(--card);
      backdrop-filter: blur(10px);overflow:hidden
    }
    .hd{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .hd b{font-size:13px}
    .bd{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], select, textarea{
      width:100%;border:1px solid var(--border);background:rgba(0,0,0,.22);
      color:var(--text);padding:10px;border-radius:12px;outline:none;
    }
    input[type="color"]{
      width:100%;height:40px;border-radius:12px;border:1px solid var(--border);background:transparent;padding:4px;
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      border:1px solid var(--border);background:rgba(124,58,237,.18);
      color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700;font-size:13px;
    }
    button.primary{background:rgba(124,58,237,.32);border-color:rgba(124,58,237,.55)}
    button.good{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.45)}
    button.bad{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.45)}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
    .status{margin-top:10px;font-size:12px;white-space:pre-wrap;line-height:1.35}
    .status.ok{color:#86efac}
    .status.err{color:#fca5a5}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .code{
      width:100%;min-height:220px;white-space:pre;overflow:auto;
      border:1px solid var(--border);background:rgba(0,0,0,.32);
      color:#e5e7eb;padding:12px;border-radius:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;line-height:1.35;
    }
    .mini{font-size:12px;color:var(--muted)}
    .previewBox{padding:14px}
    iframe{width:100%;height:460px;border:0;background:transparent;border-radius:14px}
    code{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞ (GitHub ‚Üí Genially —á–µ—Ä–µ–∑ iframe)</h1>
      <div class="sub">
        –°–ª–µ–≤–∞: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–µ–∫–æ–≤ ‚Üí —Å–ø—Ä–∞–≤–∞: –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí –Ω–∏–∂–µ: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è <b>player.html</b> –∏ <b>iframe</b> –¥–ª—è Genially.<br>
        –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <code>onegovakota-cmyk/audiopleer</code>, —Ç—Ä–µ–∫–∏ –≤ –∫–æ—Ä–Ω–µ (path –ø—É—Å—Ç–æ–π).
      </div>
    </div>
    <div class="mini">Preview ‚Ä¢ Playlist ‚Ä¢ Shuffle ‚Ä¢ Seek</div>
  </header>

  <div class="grid">
    <section class="panel">
      <div class="hd">
        <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</b>
        <span class="mini" id="tracksCount">–¢—Ä–µ–∫–æ–≤: 0</span>
      </div>

      <div class="bd">
        <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
        <select id="lang">
          <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
          <option value="en">English</option>
        </select>

        <div class="row">
          <div>
            <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
            <input id="primary" type="color" value="#7c3aed"/>
          </div>
          <div>
            <label>–ê–∫—Ü–µ–Ω—Ç (progress)</label>
            <input id="accent" type="color" value="#f97316"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
            <input id="textColor" type="color" value="#e8eefc"/>
          </div>
          <div>
            <label>–í—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
            <input id="mutedColor" type="color" value="#a9b6d6"/>
          </div>
        </div>

        <label>–û–±–ª–æ–∂–∫–∞ (URL)</label>
        <input id="coverUrl" type="text"
          value="https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800&q=80&auto=format&fit=crop"/>

        <div class="sep"></div>

        <label>–ò—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–µ–∫–æ–≤</label>
        <select id="sourceMode">
          <option value="github" selected>GitHub (public)</option>
          <option value="raw">Raw —Å—Å—ã–ª–∫–∏ (–ø–æ —Å—Ç—Ä–æ–∫–∞–º)</option>
        </select>

        <div id="githubBox">
          <div class="row">
            <div>
              <label>owner</label>
              <input id="ghOwner" type="text" value="onegovakota-cmyk"/>
            </div>
            <div>
              <label>repo</label>
              <input id="ghRepo" type="text" value="audiopleer"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>path (–ø–∞–ø–∫–∞)</label>
              <input id="ghPath" type="text" value=""/>
            </div>
            <div>
              <label>ref (–≤–µ—Ç–∫–∞)</label>
              <input id="ghRef" type="text" value="main"/>
            </div>
          </div>

          <div class="hint">
            –ï—Å–ª–∏ —Ç—Ä–µ–∫–∏ –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ‚Äî <code>path</code> –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º.<br>
            –ï—Å–ª–∏ —Ç—Ä–µ–∫–∏ –≤ –ø–∞–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä <code>audio</code>) ‚Äî —É–∫–∞–∂–∏ –µ—ë.
          </div>
        </div>

        <div id="rawBox" style="display:none">
          <label>Raw —Å—Å—ã–ª–∫–∏ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
          <textarea id="rawUrls" placeholder="https://raw.githubusercontent.com/.../track1.mp3&#10;https://raw.githubusercontent.com/.../track2.mp3"></textarea>
        </div>

        <div class="btns">
          <button class="good" id="loadTracksBtn">1) –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫–∏</button>
          <button class="primary" id="applyBtn">2) –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button class="primary" id="getCodeBtn">3) –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
          <button class="bad" id="copyPlayerBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å player.html</button>
          <button class="bad" id="copyIframeBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
        </div>

        <div id="status" class="status"></div>

        <div class="sep"></div>

        <b style="font-size:13px">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª: player.html</b>
        <pre class="code" id="playerOut"></pre>

        <div class="sep"></div>

        <b style="font-size:13px">–ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Genially (iframe)</b>
        <pre class="code" id="iframeOut"></pre>
      </div>
    </section>

    <section class="panel">
      <div class="hd">
        <b>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</b>
        <span class="mini">—ç—Ç–æ –∏–º–µ–Ω–Ω–æ player.html</span>
      </div>
      <div class="previewBox">
        <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </section>
  </div>
</div>

<script>
  const els = {
    lang: document.getElementById("lang"),
    primary: document.getElementById("primary"),
    accent: document.getElementById("accent"),
    textColor: document.getElementById("textColor"),
    mutedColor: document.getElementById("mutedColor"),
    coverUrl: document.getElementById("coverUrl"),
    sourceMode: document.getElementById("sourceMode"),
    githubBox: document.getElementById("githubBox"),
    rawBox: document.getElementById("rawBox"),
    ghOwner: document.getElementById("ghOwner"),
    ghRepo: document.getElementById("ghRepo"),
    ghPath: document.getElementById("ghPath"),
    ghRef: document.getElementById("ghRef"),
    rawUrls: document.getElementById("rawUrls"),
    loadTracksBtn: document.getElementById("loadTracksBtn"),
    applyBtn: document.getElementById("applyBtn"),
    getCodeBtn: document.getElementById("getCodeBtn"),
    copyPlayerBtn: document.getElementById("copyPlayerBtn"),
    copyIframeBtn: document.getElementById("copyIframeBtn"),
    status: document.getElementById("status"),
    tracksCount: document.getElementById("tracksCount"),
    playerOut: document.getElementById("playerOut"),
    iframeOut: document.getElementById("iframeOut"),
    previewFrame: document.getElementById("previewFrame"),
  };

  const audioExt = /\.(mp3|wav|ogg|m4a|aac)$/i;
  let tracks = []; // [{url,title}]

  function setStatus(msg, type){
    els.status.textContent = msg || "";
    els.status.className = "status " + (type || "");
  }
  function updateCount(){ els.tracksCount.textContent = "–¢—Ä–µ–∫–æ–≤: " + tracks.length; }
  function isAudioFile(name){ return audioExt.test(name || ""); }

  function contentsApiUrl(owner, repo, path, ref){
    const cleanPath = (path || "").trim().replace(/^\/+|\/+$/g,"");
    const encodedPath = cleanPath ? cleanPath.split("/").map(encodeURIComponent).join("/") : "";
    return `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodedPath}?ref=${encodeURIComponent(ref)}`;
  }

  async function fetchJson(url){
    const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
    const txt = await res.text().catch(()=> "");
    let data = null;
    try{ data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    return { ok: res.ok, status: res.status, statusText: res.statusText, data, url };
  }

  async function loadFromGitHub(owner, repo, path, ref){
    const refsToTry = Array.from(new Set([ref, "main", "master"].map(s => (s||"").trim()).filter(Boolean)));
    const cleanPath = (path || "").trim();

    async function walk(items, out){
      for(const x of items){
        if(!x) continue;
        if(x.type === "file" && isAudioFile(x.name)){
          out.push({ url: x.download_url, title: (x.name || "").replace(audioExt,"") });
        } else if(x.type === "dir" && x.url){
          const sub = await fetchJson(x.url);
          if(sub.ok && Array.isArray(sub.data)) await walk(sub.data, out);
        }
      }
    }

    let lastErr = null;
    for(const r of refsToTry){
      const url = contentsApiUrl(owner, repo, cleanPath, r);
      const res = await fetchJson(url);

      if(!res.ok){ lastErr = res; continue; }
      if(res.data && !Array.isArray(res.data) && res.data.type === "file"){
        throw new Error("path —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ñ–∞–π–ª ‚Äî —É–∫–∞–∂–∏ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –¥–ª—è –∫–æ—Ä–Ω—è.");
      }
      if(!Array.isArray(res.data)){ lastErr = res; continue; }

      const out = [];
      await walk(res.data, out);
      return { tracks: out, usedRef: r, usedPath: cleanPath || "(root)" };
    }

    const msg = (lastErr && typeof lastErr.data === "object" && lastErr.data?.message) ? lastErr.data.message : "";
    throw new Error(`GitHub API error: ${lastErr?.status || ""} ${lastErr?.statusText || ""}${msg ? " ‚Äî " + msg : ""}`);
  }

  function loadFromRawList(text){
    const urls = (text || "").split("\n").map(s=>s.trim()).filter(Boolean);
    if(urls.length === 0) throw new Error("–°–ø–∏—Å–æ–∫ raw-—Å—Å—ã–ª–æ–∫ –ø—É—Å—Ç.");
    return urls.map(u=>({ url:u, title:"" }));
  }

  function buildConfig(){
    return {
      lang: els.lang.value,
      coverUrl: els.coverUrl.value.trim(),
      colors: {
        primary: els.primary.value,
        accent: els.accent.value,
        text: els.textColor.value,
        muted: els.mutedColor.value,
      },
      github: {
        owner: els.ghOwner.value.trim(),
        repo:  els.ghRepo.value.trim(),
        path:  els.ghPath.value.trim(),
        ref:   els.ghRef.value.trim() || "main",
      },
      tracks: tracks
    };
  }

  function buildPlayerHtml(cfg){
    const safeCfg = JSON.stringify(cfg).replace(/</g, "\\u003c");

    return `<!doctype html>
<html lang="${cfg.lang}">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Audio Player</title>
<style>
:root{
  --p:${cfg.colors.primary};
  --a:${cfg.colors.accent};
  --t:${cfg.colors.text};
  --m:${cfg.colors.muted};
}
body{margin:0;background:transparent;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
#gaudio{width:min(520px,100%);color:var(--t);background:transparent;user-select:none}
#gaudio .card{
  border-radius:24px;padding:18px 18px 14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(15,20,34,.38);
  backdrop-filter:blur(10px);
  box-shadow:0 12px 40px rgba(0,0,0,.28);
  overflow:hidden;
}
#gaudio .top{display:flex;gap:14px;align-items:center}
#gaudio .ring{
  width:112px;height:112px;border-radius:999px;position:relative;flex:0 0 auto;
  background:conic-gradient(from 180deg, var(--p), rgba(255,255,255,.10), var(--p));
  padding:6px;
}
#gaudio .ring::after{
  content:"";position:absolute;inset:6px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
}
#gaudio .cover{
  position:absolute;inset:14px;border-radius:999px;
  background-size:cover;background-position:center;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
  z-index:2;
}
#gaudio .meta{min-width:0}
#gaudio .title{
  font-size:14px;font-weight:800;letter-spacing:.2px;line-height:1.2;margin:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
#gaudio .artist{
  margin-top:6px;font-size:12px;color:var(--m);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:16px;
}
#gaudio .controls{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:14px;gap:10px;
}
#gaudio .btn{
  width:40px;height:40px;border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.20);color:var(--t);
  display:grid;place-items:center;cursor:pointer;
}
#gaudio .btn:hover{border-color:rgba(255,255,255,.26)}
#gaudio .btn.primary{
  width:54px;height:54px;border-radius:18px;
  background:rgba(0,0,0,.22);
  border-color:rgba(255,255,255,.18);
  box-shadow:0 12px 28px rgba(0,0,0,.20);
}
#gaudio .btn.primary .ic{transform:translateX(1px)}
#gaudio .btn.tog{
  width:auto;height:40px;padding:0 12px;font-size:12px;color:var(--m);
  gap:8px;display:flex;align-items:center;justify-content:center;
}
#gaudio .btn.tog b{color:var(--t);font-weight:800}
#gaudio .progress{margin-top:14px}
#gaudio input[type="range"]{
  width:100%;-webkit-appearance:none;appearance:none;
  height:6px;border-radius:999px;
  background:linear-gradient(90deg, var(--a) 0%, rgba(255,255,255,.14) 0%);
  outline:none;
}
#gaudio input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;appearance:none;
  width:14px;height:14px;border-radius:50%;
  background:var(--a);
  border:1px solid rgba(255,255,255,.25);
  box-shadow:0 8px 20px rgba(0,0,0,.35);
  cursor:pointer;
}
#gaudio .time{
  display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--m);
}
#gaudio .bottom{
  display:flex;align-items:center;justify-content:space-between;margin-top:12px;
}
#gaudio .listBtn{
  width:auto;height:38px;padding:0 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.20);
  color:var(--m);cursor:pointer;font-size:12px;
}
#gaudio .listBtn:hover{border-color:rgba(255,255,255,.24)}
#gaudio .badge{
  font-size:10px;padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);color:var(--m);
}
#gaudio .listPanel{
  margin-top:12px;border-top:1px solid rgba(255,255,255,.12);
  padding-top:12px;display:none;
}
#gaudio .listPanel.open{display:block}
#gaudio .listTitle{
  font-size:12px;color:var(--m);
  display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;
}
#gaudio .track{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.16);
  margin-bottom:8px;cursor:pointer;
}
#gaudio .track:hover{border-color:rgba(255,255,255,.22)}
#gaudio .track .name{
  font-size:12px;font-weight:700;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:78%;
}
#gaudio .track.active{
  border-color:rgba(255,255,255,.28);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
}
#gaudio .statusLine{
  margin-top:10px;font-size:12px;color:var(--m);
  white-space:pre-wrap;line-height:1.35;
}
</style>
</head>
<body>
<div id="gaudio">
  <div class="card">
    <div class="top">
      <div class="ring" aria-hidden="true">
        <div class="cover" id="gaudio-cover"></div>
      </div>
      <div class="meta">
        <p class="title" id="gaudio-title">‚Äî</p>
        <div class="artist" id="gaudio-artist">${cfg.lang==="en" ? "Ready" : "–ì–æ—Ç–æ–≤–æ"}</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="gaudio-prev" title="prev">‚èÆ</button>
      <button class="btn primary" id="gaudio-play" title="play"><span class="ic" id="gaudio-play-ic">‚ñ∂</span></button>
      <button class="btn" id="gaudio-next" title="next">‚è≠</button>
      <button class="btn tog" id="gaudio-shuffle" title="shuffle">üîÄ <b id="gaudio-shuf-state">OFF</b></button>
    </div>

    <div class="progress">
      <input id="gaudio-range" type="range" min="0" max="1000" value="0" />
      <div class="time">
        <span id="gaudio-cur">0:00</span>
        <span id="gaudio-tot">0:00</span>
      </div>
    </div>

    <div class="bottom">
      <button class="listBtn" id="gaudio-listBtn">‚ò∞ ${cfg.lang==="en" ? "Playlist" : "–ü–ª–µ–π–ª–∏—Å—Ç"}</button>
      <span class="badge" id="gaudio-count">0</span>
    </div>

    <div class="listPanel" id="gaudio-list"></div>
    <div class="statusLine" id="gaudio-status"></div>
  </div>
</div>

<script>
(() => {
  const CFG = ${safeCfg};
  const audioExt = /\\.(mp3|wav|ogg|m4a|aac)$/i;

  const $cover  = document.getElementById("gaudio-cover");
  const $title  = document.getElementById("gaudio-title");
  const $artist = document.getElementById("gaudio-artist");
  const $status = document.getElementById("gaudio-status");

  const $play = document.getElementById("gaudio-play");
  const $playIc = document.getElementById("gaudio-play-ic");
  const $prev = document.getElementById("gaudio-prev");
  const $next = document.getElementById("gaudio-next");
  const $shuffle = document.getElementById("gaudio-shuffle");
  const $shufState = document.getElementById("gaudio-shuf-state");
  const $range = document.getElementById("gaudio-range");
  const $cur = document.getElementById("gaudio-cur");
  const $tot = document.getElementById("gaudio-tot");
  const $listBtn = document.getElementById("gaudio-listBtn");
  const $list = document.getElementById("gaudio-list");
  const $count = document.getElementById("gaudio-count");

  $cover.style.backgroundImage = CFG.coverUrl ? \`url("\${CFG.coverUrl}")\` : "none";

  function fmtTime(s){
    if(!isFinite(s) || s < 0) return "0:00";
    const m = Math.floor(s/60);
    const r = Math.floor(s%60);
    return m + ":" + String(r).padStart(2,"0");
  }
  function setRangeVisual(pct){
    const p = Math.max(0, Math.min(100, pct));
    $range.style.background = \`linear-gradient(90deg, var(--a) \${p}%, rgba(255,255,255,.14) \${p}%)\`;
  }
  function guessNameFromUrl(url){
    try{
      const u = new URL(url);
      const file = decodeURIComponent(u.pathname.split("/").pop() || "");
      return file.replace(audioExt,"");
    }catch(e){
      const file = (url.split("/").pop() || "").split("?")[0];
      return decodeURIComponent(file).replace(audioExt,"");
    }
  }
  function isAbs(u){ return /^https?:\\/\\//i.test(u||""); }

  let tracks = Array.isArray(CFG.tracks) ? CFG.tracks : [];
  let index = 0;
  let isShuffle = false;
  let shuffleBag = [];

  const audio = new Audio();
  audio.preload = "metadata";

  audio.addEventListener("error", () => {
    const err = audio.error;
    const code = err?.code;
    const msg =
      code === 1 ? "ABORTED" :
      code === 2 ? "NETWORK (404/–¥–æ—Å—Ç—É–ø/–Ω–µ —Å–∫–∞—á–∞–ª–æ—Å—å)" :
      code === 3 ? "DECODE (–∫–æ–¥–µ–∫/–±–∏—Ç—ã–π —Ñ–∞–π–ª)" :
      code === 4 ? "SRC_NOT_SUPPORTED (—Ñ–æ—Ä–º–∞—Ç/–∫–æ–¥–µ–∫)" :
      "UNKNOWN";
    $status.textContent = \`Audio error: \${msg}\\nURL: \${audio.src || "none"}\`;
  });

  function currentTrack(){ return tracks[index] || null; }

  function renderMeta(){
    const t = currentTrack();
    if(!t){
      $title.textContent = "‚Äî";
      $artist.textContent = (CFG.lang==="en" ? "No tracks" : "–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤");
      $tot.textContent = "0:00";
      return;
    }
    $title.textContent = t.title || guessNameFromUrl(t.url || "");
    $artist.textContent = "";
  }

  function refreshActiveRow(){
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      const i = Number(el.getAttribute("data-i"));
      el.classList.toggle("active", i===index);
    });
  }

  function renderList(){
    $count.textContent = String(tracks.length);
    const rows = tracks.map((t,i)=>{
      const name = t.title || guessNameFromUrl(t.url || "");
      return \`
        <div class="track \${i===index ? "active":""}" data-i="\${i}">
          <div class="name" title="\${name.replaceAll('"','&quot;')}">\${name}</div>
        </div>\`;
    }).join("");

    $list.innerHTML = \`
      <div class="listTitle">
        <span>\${CFG.lang==="en" ? "Playlist" : "–ü–ª–µ–π–ª–∏—Å—Ç"}</span>
        <span class="badge">\${tracks.length}</span>
      </div>
      \${rows}
    \`;

    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      el.addEventListener("click", ()=>{
        const i = Number(el.getAttribute("data-i"));
        if(Number.isFinite(i)) loadAndPlay(i, true);
      });
    });
  }

  function load(i){
    if(!tracks.length) return;
    index = (i + tracks.length) % tracks.length;
    const t = currentTrack();
    if(!isAbs(t.url)){
      $status.textContent = "Track URL must be absolute https://\\nGot: " + String(t.url || "");
      return;
    }
    audio.src = t.url;
    renderMeta();
    refreshActiveRow();
  }

  function ensureShuffleBag(){
    const arr = [];
    for(let i=0;i<tracks.length;i++) if(i!==index) arr.push(i);
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    shuffleBag = arr;
  }

  function nextIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      if(shuffleBag.length===0) ensureShuffleBag();
      return shuffleBag.shift();
    }
    return (index+1) % tracks.length;
  }

  function prevIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      let i = Math.floor(Math.random()*tracks.length);
      if(tracks.length>1 && i===index) i = (i+1)%tracks.length;
      return i;
    }
    return (index-1+tracks.length) % tracks.length;
  }

  async function loadAndPlay(i, autoplay){
    load(i);
    if(autoplay){
      try{ await audio.play(); } catch(e){ $status.textContent = "play() rejected: " + (e?.name || e); }
      syncPlayUI();
    }
  }

  function syncPlayUI(){
    const playing = !audio.paused;
    $playIc.textContent = playing ? "‚è∏" : "‚ñ∂";
  }

  $play.addEventListener("click", async ()=>{
    if(!tracks.length) return;
    if(!audio.src) load(index);
    if(audio.paused){
      try{ await audio.play(); } catch(e){ $status.textContent = "play() rejected: " + (e?.name || e); }
    } else {
      audio.pause();
    }
    syncPlayUI();
  });

  $next.addEventListener("click", ()=> loadAndPlay(nextIndex(), true));
  $prev.addEventListener("click", ()=> loadAndPlay(prevIndex(), true));

  $shuffle.addEventListener("click", ()=>{
    isShuffle = !isShuffle;
    $shufState.textContent = isShuffle ? "ON" : "OFF";
    shuffleBag = [];
    if(isShuffle) ensureShuffleBag();
  });

  $listBtn.addEventListener("click", ()=> $list.classList.toggle("open"));

  $range.addEventListener("input", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = Number($range.value)/1000;
    audio.currentTime = p * audio.duration;
  });

  audio.addEventListener("timeupdate", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = audio.currentTime / audio.duration;
    $range.value = String(Math.round(p*1000));
    setRangeVisual(p*100);
    $cur.textContent = fmtTime(audio.currentTime);
  });

  audio.addEventListener("loadedmetadata", ()=> { $tot.textContent = fmtTime(audio.duration); });
  audio.addEventListener("ended", ()=> loadAndPlay(nextIndex(), true));
  audio.addEventListener("play", syncPlayUI);
  audio.addEventListener("pause", syncPlayUI);

  renderMeta();
  renderList();
  setRangeVisual(0);
  if(tracks.length) load(0);
})();
<\/script>
</body>
</html>`;
  }

  function mountPreview(){
    const cfg = buildConfig();
    els.previewFrame.srcdoc = buildPlayerHtml(cfg);
  }

  function updateOutputs(){
    const cfg = buildConfig();
    const playerHtml = buildPlayerHtml(cfg);
    els.playerOut.textContent = playerHtml;

    const owner = cfg.github.owner || "onegovakota-cmyk";
    const repo  = cfg.github.repo  || "audiopleer";
    const pageUrl = `https://${owner}.github.io/${repo}/player.html`;

    els.iframeOut.textContent =
`<iframe
  src="${pageUrl}"
  style="width:520px;max-width:100%;height:430px;border:0;background:transparent;"
  allow="autoplay; encrypted-media"
></iframe>`;
  }

  els.sourceMode.addEventListener("change", ()=>{
    const m = els.sourceMode.value;
    els.githubBox.style.display = (m==="github") ? "" : "none";
    els.rawBox.style.display = (m==="raw") ? "" : "none";
    setStatus("", "");
  });

  els.loadTracksBtn.addEventListener("click", async ()=>{
    setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏‚Ä¶", "");
    try{
      if(els.sourceMode.value === "github"){
        const owner = els.ghOwner.value.trim();
        const repo  = els.ghRepo.value.trim();
        const path  = els.ghPath.value.trim();
        const ref   = els.ghRef.value.trim() || "main";

        const res = await loadFromGitHub(owner, repo, path, ref);
        tracks = res.tracks;

        updateCount();
        setStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${tracks.length}\nref: ${res.usedRef}\npath: ${res.usedPath}`, "ok");
      } else {
        tracks = loadFromRawList(els.rawUrls.value);
        updateCount();
        setStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${tracks.length} (raw list)`, "ok");
      }

      mountPreview();
      updateOutputs();
    }catch(e){
      setStatus(e.message || String(e), "err");
    }
  });

  els.applyBtn.addEventListener("click", ()=>{
    mountPreview();
    setStatus("–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–ª—ë–Ω.", "ok");
  });

  els.getCodeBtn.addEventListener("click", ()=>{
    updateOutputs();
    setStatus("–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.", "ok");
  });

  async function copyText(txt){
    if(!txt.trim()) throw new Error("–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ù–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª.");
    await navigator.clipboard.writeText(txt);
  }

  els.copyPlayerBtn.addEventListener("click", async ()=>{
    try{ await copyText(els.playerOut.textContent || ""); setStatus("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: player.html", "ok"); }
    catch(e){ setStatus(e.message || String(e), "err"); }
  });

  els.copyIframeBtn.addEventListener("click", async ()=>{
    try{ await copyText(els.iframeOut.textContent || ""); setStatus("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: iframe", "ok"); }
    catch(e){ setStatus(e.message || String(e), "err"); }
  });

  // init
  updateCount();
  updateOutputs();
  mountPreview();
</script>
</body>
</html>
