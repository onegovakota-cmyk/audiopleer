<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Genially Audio Player Builder</title>
  <style>
    :root{
      --ui-bg:#0b0f19;
      --ui-card:#10182a;
      --ui-text:#e8eefc;
      --ui-muted:#a9b6d6;
      --ui-border:rgba(255,255,255,.12);
      --ui-accent:#7c3aed;
      --ui-good:#22c55e;
      --ui-bad:#ef4444;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(120deg,#070a12,#0b1224 60%,#070a12);color:var(--ui-text)}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;border:1px solid var(--ui-border);border-radius:16px;
      background:rgba(16,24,42,.55);backdrop-filter: blur(10px);
    }
    header h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.2px}
    header .sub{color:var(--ui-muted);font-size:12px}
    .grid{display:grid;grid-template-columns: 420px 1fr;gap:16px;margin-top:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--ui-border);border-radius:16px;background:rgba(16,24,42,.55);
      backdrop-filter: blur(10px);overflow:hidden;
    }
    .panel .hd{
      padding:12px 14px;border-bottom:1px solid var(--ui-border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel .hd b{font-size:13px}
    .panel .bd{padding:14px}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--ui-muted);margin:10px 0 6px}
    input[type="text"], select, textarea{
      width:100%;border:1px solid var(--ui-border);background:rgba(0,0,0,.22);
      color:var(--ui-text);padding:10px 10px;border-radius:12px;outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    input[type="color"]{
      width:100%;height:40px;border-radius:12px;border:1px solid var(--ui-border);
      background:transparent;padding:4px;
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--ui-border);background:rgba(124,58,237,.18);
      color:var(--ui-text);padding:10px 12px;border-radius:12px;cursor:pointer;
      font-weight:600;font-size:13px;
    }
    button:hover{border-color:rgba(255,255,255,.22)}
    button.primary{background:rgba(124,58,237,.32);border-color:rgba(124,58,237,.55)}
    button.good{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.45)}
    button.bad{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.45)}
    .hint{margin-top:10px;color:var(--ui-muted);font-size:12px;line-height:1.35}
    .status{margin-top:10px;font-size:12px}
    .status.ok{color:#86efac}
    .status.err{color:#fca5a5}
    .code{
      width:100%;min-height:260px;white-space:pre;overflow:auto;
      border:1px solid var(--ui-border);background:rgba(0,0,0,.32);
      color:#e5e7eb;padding:12px;border-radius:12px;font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;line-height:1.35;
    }
    .mini{font-size:12px;color:var(--ui-muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--ui-border);background:rgba(0,0,0,.22);font-size:12px;color:var(--ui-muted)}
    .rightTop{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .sep{height:1px;background:var(--ui-border);margin:12px 0}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Genially Audio Player Builder</h1>
      <div class="sub">–†–µ–¥–∞–∫—Ç–æ—Ä ‚Üí –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí embed-–∫–æ–¥ –¥–ª—è Genially (–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω)</div>
    </div>
    <div class="rightTop">
      <span class="pill">–ò—Å—Ç–æ—á–Ω–∏–∫: GitHub API / raw URLs</span>
      <span class="pill">Shuffle ‚Ä¢ Playlist ‚Ä¢ Seek</span>
    </div>
  </header>

  <div class="grid">
    <section class="panel">
      <div class="hd">
        <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>
        <span class="mini" id="tracksCount">–¢—Ä–µ–∫–æ–≤: 0</span>
      </div>
      <div class="bd">
        <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
        <select id="lang">
          <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
          <option value="en">English</option>
        </select>

        <div class="row">
          <div>
            <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–∫–æ–ª—å—Ü–æ / –∫–Ω–æ–ø–∫–∏)</label>
            <input id="primary" type="color" value="#7c3aed" />
          </div>
          <div>
            <label>–ê–∫—Ü–µ–Ω—Ç (progress / hover)</label>
            <input id="accent" type="color" value="#f97316" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
            <input id="textColor" type="color" value="#e8eefc" />
          </div>
          <div>
            <label>–í—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
            <input id="mutedColor" type="color" value="#a9b6d6" />
          </div>
        </div>

        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ (URL)</label>
        <input id="coverUrl" type="text" placeholder="https://.../cover.jpg" value="https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800&q=80&auto=format&fit=crop" />

        <div class="sep"></div>

        <label>–ò—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–µ–∫–æ–≤</label>
        <select id="sourceMode">
          <option value="github" selected>GitHub –ø–∞–ø–∫–∞ (public)</option>
          <option value="raw">Raw —Å—Å—ã–ª–∫–∏ (—Å–ø–∏—Å–æ–∫)</option>
        </select>

        <div id="githubBox">
          <div class="row">
            <div>
              <label>owner</label>
              <input id="ghOwner" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: onegovakota-cmyk" value="onegovakota-cmyk" />
            </div>
            <div>
              <label>repo</label>
              <input id="ghRepo" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: audioplayer" value="audioplayer" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>–ü–∞–ø–∫–∞ –≤ —Ä–µ–ø–æ</label>
              <input id="ghPath" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: audio" value="audio" />
            </div>
            <div>
              <label>–í–µ—Ç–∫–∞ (ref)</label>
              <input id="ghRef" type="text" placeholder="main" value="main" />
            </div>
          </div>
          <div class="hint">
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: mp3, wav, ogg, m4a, aac.<br>
            –î–æ–ª–∂–µ–Ω –±—ã—Ç—å <b>public</b> —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. GitHub API –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limit).
          </div>
        </div>

        <div id="rawBox" style="display:none">
          <label>Raw —Å—Å—ã–ª–∫–∏ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
          <textarea id="rawUrls" placeholder="https://raw.githubusercontent.com/.../track1.mp3&#10;https://.../track2.mp3"></textarea>
          <div class="hint">
            –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å raw-—Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä –∏–∑ GitHub ‚ÄúRaw‚Äù.
          </div>
        </div>

        <div class="btns">
          <button class="good" id="loadTracksBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫–∏</button>
          <button class="primary" id="applyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button class="primary" id="getCodeBtn">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
          <button class="bad" id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        </div>

        <div id="status" class="status"></div>

        <div class="sep"></div>
        <b style="font-size:13px">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π embed-–∫–æ–¥</b>
        <div class="hint" style="margin-top:6px">
          –í—Å—Ç–∞–≤—å –≤ Genially —á–µ—Ä–µ–∑ –±–ª–æ–∫/–≤–∏–¥–∂–µ—Ç, –≥–¥–µ —Ä–∞–∑—Ä–µ—à—ë–Ω HTML (–∏–ª–∏ —á–µ—Ä–µ–∑ iframe, –µ—Å–ª–∏ —É –≤–∞—Å —Ç–∞–∫ –ø—Ä–∏–Ω—è—Ç–æ).
          –ö–æ–¥ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –∏ —Ä–∏—Å—É–µ—Ç –ø–ª–µ–µ—Ä –Ω–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–º —Ñ–æ–Ω–µ.
        </div>
        <pre class="code" id="codeOut"></pre>
      </div>
    </section>

    <section class="panel">
      <div class="hd">
        <b>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</b>
        <span class="mini">—Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π</span>
      </div>
      <div class="bd">
        <div id="previewMount"></div>
      </div>
    </section>
  </div>
</div>

<script>
/** =========================
 *  AUDIO PLAYER EMBED TEMPLATE
 *  (–±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –≤ Genially)
 *  ========================= */
function buildEmbedHTML(config){
  // –í–∞–∂–Ω–æ: embed –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –≤—Å–µ –≤ –æ–¥–Ω–æ–º.
  // config –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–∫ JSON.
  const safeJson = JSON.stringify(config).replace(/</g, "\\u003c");
  return `<!-- Genially Audio Player (transparent) -->
<div id="gaudio-root"></div>
<script>
(function(){
  const CONFIG = ${safeJson};

  const STR = {
    ru: {
      playlist: "–ü–ª–µ–π–ª–∏—Å—Ç",
      shuffleOn: "–†–∞–Ω–¥–æ–º: –í–ö–õ",
      shuffleOff: "–†–∞–Ω–¥–æ–º: –í–´–ö–õ",
      prev: "–ù–∞–∑–∞–¥",
      next: "–í–ø–µ—Ä—ë–¥",
      play: "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏",
      pause: "–ü–∞—É–∑–∞",
      empty: "–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤"
    },
    en: {
      playlist: "Playlist",
      shuffleOn: "Shuffle: ON",
      shuffleOff: "Shuffle: OFF",
      prev: "Prev",
      next: "Next",
      play: "Play",
      pause: "Pause",
      empty: "No tracks"
    }
  };

  const lang = (CONFIG.lang || "ru") in STR ? (CONFIG.lang || "ru") : "ru";
  const T = STR[lang];

  const mount = document.getElementById("gaudio-root");
  if(!mount) return;

  // ---------- styles ----------
  const css = \`
  :root{
    --p:\${CONFIG.colors?.primary || "#7c3aed"};
    --a:\${CONFIG.colors?.accent || "#f97316"};
    --t:\${CONFIG.colors?.text || "#e8eefc"};
    --m:\${CONFIG.colors?.muted || "#a9b6d6"};
  }
  /* transparent background by default */
  #gaudio{
    width: min(520px, 100%);
    color: var(--t);
    background: transparent;
    position: relative;
    user-select: none;
  }
  #gaudio .card{
    border-radius: 24px;
    padding: 18px 18px 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(15, 20, 34, .38);
    backdrop-filter: blur(10px);
    box-shadow: 0 12px 40px rgba(0,0,0,.28);
    overflow: hidden;
  }
  #gaudio .top{
    display:flex; gap:14px; align-items:center;
  }
  #gaudio .ring{
    width: 112px; height:112px; border-radius: 999px;
    position: relative; flex: 0 0 auto;
    background:
      radial-gradient(circle at 50% 50%, rgba(0,0,0,.0) 60%, rgba(0,0,0,.0) 61%),
      conic-gradient(from 180deg, var(--p), rgba(255,255,255,.10), var(--p));
    padding: 6px;
  }
  #gaudio .ring::after{
    content:""; position:absolute; inset: 6px; border-radius:999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
  }
  #gaudio .cover{
    position:absolute; inset: 14px; border-radius: 999px;
    background-size: cover; background-position: center;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
    z-index: 2;
  }
  #gaudio .meta{min-width:0}
  #gaudio .title{
    font-size: 14px; font-weight: 800; letter-spacing:.2px;
    line-height:1.2; margin:0;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #gaudio .artist{
    margin-top:6px;
    font-size: 12px; color: var(--m);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #gaudio .controls{
    display:flex; align-items:center; justify-content:space-between;
    margin-top: 14px; gap: 10px;
  }
  #gaudio .btn{
    width: 40px; height: 40px; border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.20);
    color: var(--t);
    display:grid; place-items:center;
    cursor:pointer;
  }
  #gaudio .btn:hover{border-color: rgba(255,255,255,.26)}
  #gaudio .btn.primary{
    width: 54px; height: 54px; border-radius: 18px;
    background: rgba(0,0,0,.22);
    border-color: rgba(255,255,255,.18);
    box-shadow: 0 12px 28px rgba(0,0,0,.20);
  }
  #gaudio .btn.primary .ic{transform: translateX(1px)}
  #gaudio .btn.tog{
    width: auto; height: 40px; padding: 0 12px;
    font-size: 12px; color: var(--m);
    gap: 8px; display:flex; align-items:center; justify-content:center;
  }
  #gaudio .btn.tog b{color: var(--t); font-weight:800}
  #gaudio .progress{
    margin-top: 14px;
  }
  #gaudio input[type="range"]{
    width:100%;
    -webkit-appearance:none; appearance:none;
    height: 6px; border-radius: 999px;
    background: linear-gradient(90deg, var(--a) 0%, rgba(255,255,255,.14) 0%);
    outline:none;
  }
  #gaudio input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width: 14px; height: 14px; border-radius: 50%;
    background: var(--a);
    border: 1px solid rgba(255,255,255,.25);
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
    cursor:pointer;
  }
  #gaudio .time{
    display:flex; justify-content:space-between;
    margin-top: 8px; font-size: 11px; color: var(--m);
  }
  #gaudio .bottom{
    display:flex; align-items:center; justify-content:space-between;
    margin-top: 12px;
  }
  #gaudio .plink{
    display:flex; align-items:center; gap:10px;
  }
  #gaudio .listBtn{
    width: auto; height: 38px; padding:0 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.20);
    color: var(--m);
    cursor:pointer;
    font-size: 12px;
  }
  #gaudio .listBtn:hover{border-color: rgba(255,255,255,.24)}
  #gaudio .listPanel{
    margin-top: 12px;
    border-top: 1px solid rgba(255,255,255,.12);
    padding-top: 12px;
    display:none;
  }
  #gaudio .listPanel.open{display:block}
  #gaudio .listTitle{
    font-size: 12px; color: var(--m); display:flex; justify-content:space-between; align-items:center;
    margin-bottom: 8px;
  }
  #gaudio .track{
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 10px; border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.16);
    margin-bottom: 8px;
    cursor:pointer;
  }
  #gaudio .track:hover{border-color: rgba(255,255,255,.22)}
  #gaudio .track .name{
    font-size: 12px; font-weight: 700;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    max-width: 70%;
  }
  #gaudio .track .dur{font-size: 11px; color: var(--m)}
  #gaudio .track.active{
    border-color: rgba(255,255,255,.28);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }
  #gaudio .badge{
    font-size: 10px; padding: 4px 8px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18); color: var(--m);
  }
  \`;

  const style = document.createElement("style");
  style.textContent = css;
  document.head.appendChild(style);

  // ---------- markup ----------
  const el = document.createElement("div");
  el.id = "gaudio";
  el.innerHTML = \`
    <div class="card">
      <div class="top">
        <div class="ring" aria-hidden="true">
          <div class="cover" id="gaudio-cover"></div>
        </div>
        <div class="meta">
          <p class="title" id="gaudio-title">‚Äî</p>
          <div class="artist" id="gaudio-artist">‚Äî</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="gaudio-prev" title="\${T.prev}" aria-label="\${T.prev}">
          <span class="ic">‚èÆ</span>
        </button>

        <button class="btn primary" id="gaudio-play" title="\${T.play}" aria-label="\${T.play}">
          <span class="ic" id="gaudio-play-ic">‚ñ∂</span>
        </button>

        <button class="btn" id="gaudio-next" title="\${T.next}" aria-label="\${T.next}">
          <span class="ic">‚è≠</span>
        </button>

        <button class="btn tog" id="gaudio-shuffle" title="\${T.shuffleOff}" aria-label="shuffle">
          <span>üîÄ</span><b id="gaudio-shuf-state">OFF</b>
        </button>
      </div>

      <div class="progress">
        <input id="gaudio-range" type="range" min="0" max="1000" value="0" />
        <div class="time">
          <span id="gaudio-cur">0:00</span>
          <span id="gaudio-tot">0:00</span>
        </div>
      </div>

      <div class="bottom">
        <button class="listBtn" id="gaudio-listBtn">‚ò∞ \${T.playlist}</button>
        <span class="badge" id="gaudio-count">0</span>
      </div>

      <div class="listPanel" id="gaudio-list"></div>
    </div>
  \`;
  mount.appendChild(el);

  // ---------- player logic ----------
  const audio = new Audio();
  audio.preload = "metadata";

  const tracks = Array.isArray(CONFIG.tracks) ? CONFIG.tracks : [];
  const coverUrl = CONFIG.coverUrl || "";

  const $cover = document.getElementById("gaudio-cover");
  const $title = document.getElementById("gaudio-title");
  const $artist = document.getElementById("gaudio-artist");
  const $play = document.getElementById("gaudio-play");
  const $playIc = document.getElementById("gaudio-play-ic");
  const $prev = document.getElementById("gaudio-prev");
  const $next = document.getElementById("gaudio-next");
  const $shuffle = document.getElementById("gaudio-shuffle");
  const $shufState = document.getElementById("gaudio-shuf-state");
  const $range = document.getElementById("gaudio-range");
  const $cur = document.getElementById("gaudio-cur");
  const $tot = document.getElementById("gaudio-tot");
  const $listBtn = document.getElementById("gaudio-listBtn");
  const $list = document.getElementById("gaudio-list");
  const $count = document.getElementById("gaudio-count");

  $cover.style.backgroundImage = coverUrl ? \`url("\${coverUrl}")\` : "none";

  let index = 0;
  let isShuffle = false;
  let shuffleBag = [];

  function fmtTime(s){
    if(!isFinite(s) || s < 0) return "0:00";
    const m = Math.floor(s/60);
    const r = Math.floor(s%60);
    return m + ":" + String(r).padStart(2,"0");
  }

  function setRangeVisual(p){
    const pct = Math.max(0, Math.min(100, p));
    $range.style.background = \`linear-gradient(90deg, var(--a) \${pct}%, rgba(255,255,255,.14) \${pct}%)\`;
  }

  function guessNameFromUrl(url){
    try{
      const u = new URL(url);
      const file = decodeURIComponent(u.pathname.split("/").pop() || "");
      return file.replace(/\\.(mp3|wav|ogg|m4a|aac)$/i,"");
    }catch(e){
      const file = (url.split("/").pop() || "").split("?")[0];
      return decodeURIComponent(file).replace(/\\.(mp3|wav|ogg|m4a|aac)$/i,"");
    }
  }

  function currentTrack(){
    return tracks[index] || null;
  }

  function renderMeta(){
    const t = currentTrack();
    if(!t){
      $title.textContent = "‚Äî";
      $artist.textContent = T.empty;
      $tot.textContent = "0:00";
      return;
    }
    $title.textContent = t.title || guessNameFromUrl(t.url || "");
    $artist.textContent = t.artist || "";
  }

  function renderList(){
    $count.textContent = String(tracks.length);
    const rows = tracks.map((t,i)=>{
      const name = (t.title || guessNameFromUrl(t.url || ""));
      return \`
        <div class="track \${i===index ? "active":""}" data-i="\${i}">
          <div class="name" title="\${name.replaceAll('"','&quot;')}">\${name}</div>
          <div class="dur" id="gaudio-dur-\${i}">--:--</div>
        </div>
      \`;
    }).join("");
    $list.innerHTML = \`
      <div class="listTitle">
        <span>\${T.playlist}</span>
        <span class="badge">\${tracks.length}</span>
      </div>
      \${rows}
    \`;
    // click handlers
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      el.addEventListener("click", ()=>{
        const i = Number(el.getAttribute("data-i"));
        if(Number.isFinite(i)) loadAndPlay(i, true);
      });
    });
  }

  function refreshActiveRow(){
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      const i = Number(el.getAttribute("data-i"));
      el.classList.toggle("active", i===index);
    });
  }

  function load(i){
    if(!tracks.length) return;
    index = (i + tracks.length) % tracks.length;
    const t = currentTrack();
    audio.src = t.url;
    renderMeta();
    refreshActiveRow();
  }

  function ensureShuffleBag(){
    // bag = –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ, –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–µ
    const arr = [];
    for(let i=0;i<tracks.length;i++) if(i!==index) arr.push(i);
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    shuffleBag = arr;
  }

  function nextIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      if(shuffleBag.length===0) ensureShuffleBag();
      return shuffleBag.shift();
    }
    return (index+1) % tracks.length;
  }

  function prevIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      // –ø—Ä–∏ shuffle "–Ω–∞–∑–∞–¥" –¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç–æ —Å–ª—É—á–∞–π–Ω—ã–π, –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
      let i = Math.floor(Math.random()*tracks.length);
      if(tracks.length>1 && i===index) i = (i+1)%tracks.length;
      return i;
    }
    return (index-1+tracks.length) % tracks.length;
  }

  async function loadAndPlay(i, autoplay){
    load(i);
    if(autoplay){
      try{ await audio.play(); }catch(e){}
      syncPlayUI();
    }
  }

  function syncPlayUI(){
    const playing = !audio.paused;
    $playIc.textContent = playing ? "‚è∏" : "‚ñ∂";
    $play.title = playing ? T.pause : T.play;
    $play.setAttribute("aria-label", playing ? T.pause : T.play);
  }

  // wire controls
  $play.addEventListener("click", async ()=>{
    if(!tracks.length) return;
    if(audio.src === "" || audio.src == null) load(index);
    if(audio.paused){
      try{ await audio.play(); }catch(e){}
    }else{
      audio.pause();
    }
    syncPlayUI();
  });

  $next.addEventListener("click", ()=> loadAndPlay(nextIndex(), true));
  $prev.addEventListener("click", ()=> loadAndPlay(prevIndex(), true));

  $shuffle.addEventListener("click", ()=>{
    isShuffle = !isShuffle;
    $shufState.textContent = isShuffle ? "ON" : "OFF";
    $shuffle.title = isShuffle ? T.shuffleOn : T.shuffleOff;
    shuffleBag = [];
    if(isShuffle) ensureShuffleBag();
  });

  $listBtn.addEventListener("click", ()=>{
    $list.classList.toggle("open");
  });

  $range.addEventListener("input", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = Number($range.value)/1000;
    audio.currentTime = p * audio.duration;
  });

  audio.addEventListener("timeupdate", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = audio.currentTime / audio.duration;
    const pct = p*100;
    $range.value = String(Math.round(p*1000));
    setRangeVisual(pct);
    $cur.textContent = fmtTime(audio.currentTime);
  });

  audio.addEventListener("loadedmetadata", ()=>{
    $tot.textContent = fmtTime(audio.duration);
  });

  audio.addEventListener("ended", ()=>{
    loadAndPlay(nextIndex(), true);
  });

  audio.addEventListener("play", syncPlayUI);
  audio.addEventListener("pause", syncPlayUI);

  // init
  renderMeta();
  renderList();
  setRangeVisual(0);

  if(tracks.length){
    load(0);
  }

})();
<\/script>
<!-- /Genially Audio Player -->
`;
}

/** =========================
 *  BUILDER APP (editor)
 *  ========================= */
const els = {
  lang: document.getElementById("lang"),
  primary: document.getElementById("primary"),
  accent: document.getElementById("accent"),
  textColor: document.getElementById("textColor"),
  mutedColor: document.getElementById("mutedColor"),
  coverUrl: document.getElementById("coverUrl"),
  sourceMode: document.getElementById("sourceMode"),
  githubBox: document.getElementById("githubBox"),
  rawBox: document.getElementById("rawBox"),
  ghOwner: document.getElementById("ghOwner"),
  ghRepo: document.getElementById("ghRepo"),
  ghPath: document.getElementById("ghPath"),
  ghRef: document.getElementById("ghRef"),
  rawUrls: document.getElementById("rawUrls"),
  loadTracksBtn: document.getElementById("loadTracksBtn"),
  applyBtn: document.getElementById("applyBtn"),
  getCodeBtn: document.getElementById("getCodeBtn"),
  copyBtn: document.getElementById("copyBtn"),
  status: document.getElementById("status"),
  codeOut: document.getElementById("codeOut"),
  previewMount: document.getElementById("previewMount"),
  tracksCount: document.getElementById("tracksCount"),
};

let tracks = []; // [{url,title?,artist?}]

function setStatus(msg, type){
  els.status.textContent = msg || "";
  els.status.className = "status " + (type || "");
}

function updateCount(){
  els.tracksCount.textContent = "–¢—Ä–µ–∫–æ–≤: " + tracks.length;
}

function normalizeTrack(url){
  return { url: url.trim() };
}

function isAudioFile(name){
  return /\.(mp3|wav|ogg|m4a|aac)$/i.test(name || "");
}

async function loadFromGitHub(owner, repo, path, ref){
  const api = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path || "")}?ref=${encodeURIComponent(ref || "main")}`;
  const res = await fetch(api, { headers: { "Accept": "application/vnd.github+json" } });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`GitHub API error: ${res.status} ${res.statusText}${t ? " ‚Äî " + t : ""}`);
  }
  const data = await res.json();
  if(!Array.isArray(data)) throw new Error("–û–∂–∏–¥–∞–ª—Å—è —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (–ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ path —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–∞–ø–∫—É).");
  const aud = data
    .filter(x => x && x.type === "file" && isAudioFile(x.name))
    .map(x => ({ url: x.download_url, title: x.name.replace(/\.(mp3|wav|ogg|m4a|aac)$/i,"") }));

  if(aud.length === 0) throw new Error("–í –ø–∞–ø–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.");
  return aud;
}

function loadFromRawList(text){
  const urls = (text || "")
    .split("\n")
    .map(s => s.trim())
    .filter(Boolean);
  const aud = urls.map(normalizeTrack);
  if(aud.length === 0) throw new Error("–°–ø–∏—Å–æ–∫ raw-—Å—Å—ã–ª–æ–∫ –ø—É—Å—Ç.");
  return aud;
}

function buildConfig(){
  return {
    lang: els.lang.value,
    coverUrl: els.coverUrl.value.trim(),
    colors: {
      primary: els.primary.value,
      accent: els.accent.value,
      text: els.textColor.value,
      muted: els.mutedColor.value,
    },
    tracks: tracks
  };
}

function mountPreview(){
  els.previewMount.innerHTML = "";
  const cfg = buildConfig();
  const html = buildEmbedHTML(cfg);
  // –í –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–∫ DOM:
  const sandbox = document.createElement("div");
  sandbox.innerHTML = html;
  els.previewMount.appendChild(sandbox);

  // –ò—Å–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –∏–∑ –≤—Å—Ç–∞–≤–∫–∏ (–ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å script-—Ç–µ–≥)
  sandbox.querySelectorAll("script").forEach(scr=>{
    const s = document.createElement("script");
    if(scr.src) s.src = scr.src;
    s.textContent = scr.textContent;
    scr.replaceWith(s);
  });
}

els.sourceMode.addEventListener("change", ()=>{
  const m = els.sourceMode.value;
  els.githubBox.style.display = (m==="github") ? "" : "none";
  els.rawBox.style.display = (m==="raw") ? "" : "none";
  setStatus("", "");
});

els.loadTracksBtn.addEventListener("click", async ()=>{
  setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏‚Ä¶", "");
  try{
    if(els.sourceMode.value === "github"){
      const owner = els.ghOwner.value.trim();
      const repo = els.ghRepo.value.trim();
      const path = els.ghPath.value.trim();
      const ref  = els.ghRef.value.trim() || "main";
      if(!owner || !repo) throw new Error("–ó–∞–ø–æ–ª–Ω–∏ owner –∏ repo.");
      tracks = await loadFromGitHub(owner, repo, path, ref);
    }else{
      tracks = loadFromRawList(els.rawUrls.value);
    }
    updateCount();
    setStatus("–¢—Ä–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: " + tracks.length, "ok");
    mountPreview();
  }catch(e){
    setStatus(e.message || String(e), "err");
  }
});

els.applyBtn.addEventListener("click", ()=>{
  try{
    mountPreview();
    setStatus("–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.", "ok");
  }catch(e){
    setStatus(e.message || String(e), "err");
  }
});

els.getCodeBtn.addEventListener("click", ()=>{
  try{
    const cfg = buildConfig();
    const code = buildEmbedHTML(cfg);
    els.codeOut.textContent = code;
    setStatus("–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –ú–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially.", "ok");
  }catch(e){
    setStatus(e.message || String(e), "err");
  }
});

els.copyBtn.addEventListener("click", async ()=>{
  try{
    const txt = els.codeOut.textContent || "";
    if(!txt.trim()) throw new Error("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª.");
    await navigator.clipboard.writeText(txt);
    setStatus("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.", "ok");
  }catch(e){
    setStatus(e.message || String(e), "err");
  }
});

// —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–ø—É—Å—Ç–æ)
updateCount();
mountPreview();
</script>
</body>
</html>
