<div id="gaudio-root"></div>

<script>
(() => {
  // =========================
  // CONFIG (–ù–ê–°–¢–†–û–ô–ö–ò)
  // =========================
  const GITHUB_OWNER = "onegovakota-cmyk";
  const GITHUB_REPO  = "audiopleer";
  const GITHUB_PATH  = "audio";     // ‚Üê –ø–∞–ø–∫–∞ —Å —Ç—Ä–µ–∫–∞–º–∏. –ï—Å–ª–∏ —Ç—Ä–µ–∫–∏ –≤ –∫–æ—Ä–Ω–µ ‚Äî –ø–æ—Å—Ç–∞–≤—å ""
  const GITHUB_REF   = "main";      // ‚Üê –≤–µ—Ç–∫–∞: main / master / –¥—Ä—É–≥–∞—è

  const LANG = "ru"; // "ru" –∏–ª–∏ "en"

  const COLORS = {
    primary: "#7c3aed",
    accent:  "#f97316",
    text:    "#e8eefc",
    muted:   "#a9b6d6",
  };

  const COVER_URL = "https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800&q=80&auto=format&fit=crop";
  const MAX_TRACKS = 500; // –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

  // =========================
  // STRINGS
  // =========================
  const STR = {
    ru: {
      loading: "–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏ –∏–∑ GitHub‚Ä¶",
      loadErr: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫–∏",
      empty:   "–í –ø–∞–ø–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤",
      playlist:"–ü–ª–µ–π–ª–∏—Å—Ç",
      shuffleOn:"–†–∞–Ω–¥–æ–º: –í–ö–õ",
      shuffleOff:"–†–∞–Ω–¥–æ–º: –í–´–ö–õ",
      prev:"–ù–∞–∑–∞–¥",
      next:"–í–ø–µ—Ä—ë–¥",
      play:"–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏",
      pause:"–ü–∞—É–∑–∞",
    },
    en: {
      loading: "Loading tracks from GitHub‚Ä¶",
      loadErr: "Failed to load tracks",
      empty:   "No audio files found in folder",
      playlist:"Playlist",
      shuffleOn:"Shuffle: ON",
      shuffleOff:"Shuffle: OFF",
      prev:"Prev",
      next:"Next",
      play:"Play",
      pause:"Pause",
    }
  };
  const T = STR[LANG] || STR.ru;

  // =========================
  // HELPERS
  // =========================
  const audioExt = /\.(mp3|wav|ogg|m4a|aac)$/i;

  function fmtTime(s){
    if(!isFinite(s) || s < 0) return "0:00";
    const m = Math.floor(s/60);
    const r = Math.floor(s%60);
    return m + ":" + String(r).padStart(2,"0");
  }

  function guessNameFromUrl(url){
    try{
      const u = new URL(url);
      const file = decodeURIComponent(u.pathname.split("/").pop() || "");
      return file.replace(audioExt,"");
    }catch(e){
      const file = (url.split("/").pop() || "").split("?")[0];
      return decodeURIComponent(file).replace(audioExt,"");
    }
  }

  function setRangeVisual(rangeEl, pct){
    const p = Math.max(0, Math.min(100, pct));
    rangeEl.style.background = `linear-gradient(90deg, var(--a) ${p}%, rgba(255,255,255,.14) ${p}%)`;
  }

  function githubContentsUrl(owner, repo, path, ref){
    const cleanPath = (path || "").trim().replace(/^\/+|\/+$/g,"");
    const encodedPath = cleanPath ? cleanPath.split("/").map(encodeURIComponent).join("/") : "";
    return `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodedPath}?ref=${encodeURIComponent(ref)}`;
  }

  async function fetchJson(url){
    const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
    const text = await res.text().catch(()=> "");
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    return {
      ok: res.ok,
      status: res.status,
      statusText: res.statusText,
      data,
      url,
      rateRemaining: res.headers.get("x-ratelimit-remaining"),
      rateReset: res.headers.get("x-ratelimit-reset"),
    };
  }

  async function loadTracksFromGitHub({owner, repo, path, ref}){
    const refsToTry = Array.from(new Set([ref, "main", "master"].map(s => (s||"").trim()).filter(Boolean)));
    const startPath = (path || "").trim();

    async function walk(items, out){
      for(const x of items){
        if(out.length >= MAX_TRACKS) return;
        if(!x) continue;

        if(x.type === "file" && audioExt.test(x.name || "")){
          out.push({
            url: x.download_url,
            title: (x.name || "").replace(audioExt,"") || guessNameFromUrl(x.download_url || "")
          });
          continue;
        }

        if(x.type === "dir" && x.url){
          const sub = await fetchJson(x.url);
          if(sub.ok && Array.isArray(sub.data)){
            await walk(sub.data, out);
          }
        }
      }
    }

    let lastErr = null;

    for(const r of refsToTry){
      const url = githubContentsUrl(owner, repo, startPath, r);
      const res = await fetchJson(url);

      if(!res.ok){
        lastErr = res;
        continue;
      }

      if(res.data && !Array.isArray(res.data) && res.data.type === "file"){
        throw new Error(`PATH —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ñ–∞–π–ª, –∞ –Ω—É–∂–µ–Ω –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ. URL: ${url}`);
      }

      if(!Array.isArray(res.data)){
        lastErr = res;
        continue;
      }

      const out = [];
      await walk(res.data, out);

      return { tracks: out, usedRef: r, usedPath: startPath || "(root)" };
    }

    const msg = (lastErr && typeof lastErr.data === "object" && lastErr.data?.message) ? lastErr.data.message : "";
    const rate = lastErr?.rateRemaining != null ? ` (rate remaining: ${lastErr.rateRemaining})` : "";
    throw new Error(`${T.loadErr}: ${lastErr?.status || ""} ${lastErr?.statusText || ""}${rate}${msg ? " ‚Äî " + msg : ""}`);
  }

  // =========================
  // UI MOUNT
  // =========================
  const mount = document.getElementById("gaudio-root");
  if(!mount) return;

  const style = document.createElement("style");
  style.textContent = `
    :root{
      --p:${COLORS.primary};
      --a:${COLORS.accent};
      --t:${COLORS.text};
      --m:${COLORS.muted};
    }
    #gaudio{
      width:min(520px,100%);
      color:var(--t);
      background:transparent;
      user-select:none;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    #gaudio .card{
      border-radius:24px;
      padding:18px 18px 14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,20,34,.38);
      backdrop-filter:blur(10px);
      box-shadow:0 12px 40px rgba(0,0,0,.28);
      overflow:hidden;
    }
    #gaudio .top{display:flex;gap:14px;align-items:center}
    #gaudio .ring{
      width:112px;height:112px;border-radius:999px;position:relative;flex:0 0 auto;
      background:conic-gradient(from 180deg, var(--p), rgba(255,255,255,.10), var(--p));
      padding:6px;
    }
    #gaudio .ring::after{
      content:"";position:absolute;inset:6px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    #gaudio .cover{
      position:absolute;inset:14px;border-radius:999px;
      background-size:cover;background-position:center;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
      z-index:2;
    }
    #gaudio .meta{min-width:0}
    #gaudio .title{
      font-size:14px;font-weight:800;letter-spacing:.2px;line-height:1.2;margin:0;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    #gaudio .artist{
      margin-top:6px;font-size:12px;color:var(--m);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      min-height: 16px;
    }
    #gaudio .controls{
      display:flex;align-items:center;justify-content:space-between;
      margin-top:14px;gap:10px;
    }
    #gaudio .btn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--t);
      display:grid;place-items:center;cursor:pointer;
    }
    #gaudio .btn:hover{border-color:rgba(255,255,255,.26)}
    #gaudio .btn.primary{
      width:54px;height:54px;border-radius:18px;
      background:rgba(0,0,0,.22);
      border-color:rgba(255,255,255,.18);
      box-shadow:0 12px 28px rgba(0,0,0,.20);
    }
    #gaudio .btn.primary .ic{transform:translateX(1px)}
    #gaudio .btn.tog{
      width:auto;height:40px;padding:0 12px;
      font-size:12px;color:var(--m);
      gap:8px;display:flex;align-items:center;justify-content:center;
    }
    #gaudio .btn.tog b{color:var(--t);font-weight:800}
    #gaudio .progress{margin-top:14px}
    #gaudio input[type="range"]{
      width:100%;-webkit-appearance:none;appearance:none;
      height:6px;border-radius:999px;
      background:linear-gradient(90deg, var(--a) 0%, rgba(255,255,255,.14) 0%);
      outline:none;
    }
    #gaudio input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;
      width:14px;height:14px;border-radius:50%;
      background:var(--a);
      border:1px solid rgba(255,255,255,.25);
      box-shadow:0 8px 20px rgba(0,0,0,.35);
      cursor:pointer;
    }
    #gaudio .time{
      display:flex;justify-content:space-between;
      margin-top:8px;font-size:11px;color:var(--m);
    }
    #gaudio .bottom{
      display:flex;align-items:center;justify-content:space-between;
      margin-top:12px;
    }
    #gaudio .listBtn{
      width:auto;height:38px;padding:0 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--m);cursor:pointer;font-size:12px;
    }
    #gaudio .listBtn:hover{border-color:rgba(255,255,255,.24)}
    #gaudio .badge{
      font-size:10px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--m);
    }
    #gaudio .listPanel{
      margin-top:12px;border-top:1px solid rgba(255,255,255,.12);
      padding-top:12px;display:none;
    }
    #gaudio .listPanel.open{display:block}
    #gaudio .listTitle{
      font-size:12px;color:var(--m);
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:8px;
    }
    #gaudio .track{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:8px;cursor:pointer;
    }
    #gaudio .track:hover{border-color:rgba(255,255,255,.22)}
    #gaudio .track .name{
      font-size:12px;font-weight:700;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:78%;
    }
    #gaudio .track.active{
      border-color:rgba(255,255,255,.28);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
    }
    #gaudio .statusLine{
      margin-top:10px;
      font-size:12px;
      color:var(--m);
      white-space:pre-wrap;
      line-height:1.35;
    }
  `;
  document.head.appendChild(style);

  mount.innerHTML = `
    <div id="gaudio">
      <div class="card">
        <div class="top">
          <div class="ring" aria-hidden="true">
            <div class="cover" id="gaudio-cover"></div>
          </div>
          <div class="meta">
            <p class="title" id="gaudio-title">‚Äî</p>
            <div class="artist" id="gaudio-artist">${T.loading}</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="gaudio-prev" title="${T.prev}" aria-label="${T.prev}">‚èÆ</button>
          <button class="btn primary" id="gaudio-play" title="${T.play}" aria-label="${T.play}">
            <span class="ic" id="gaudio-play-ic">‚ñ∂</span>
          </button>
          <button class="btn" id="gaudio-next" title="${T.next}" aria-label="${T.next}">‚è≠</button>
          <button class="btn tog" id="gaudio-shuffle" title="${T.shuffleOff}" aria-label="shuffle">
            üîÄ <b id="gaudio-shuf-state">OFF</b>
          </button>
        </div>

        <div class="progress">
          <input id="gaudio-range" type="range" min="0" max="1000" value="0" />
          <div class="time">
            <span id="gaudio-cur">0:00</span>
            <span id="gaudio-tot">0:00</span>
          </div>
        </div>

        <div class="bottom">
          <button class="listBtn" id="gaudio-listBtn">‚ò∞ ${T.playlist}</button>
          <span class="badge" id="gaudio-count">0</span>
        </div>

        <div class="listPanel" id="gaudio-list"></div>
        <div class="statusLine" id="gaudio-status"></div>
      </div>
    </div>
  `;

  const $cover = document.getElementById("gaudio-cover");
  const $title = document.getElementById("gaudio-title");
  const $artist = document.getElementById("gaudio-artist");
  const $status = document.getElementById("gaudio-status");

  const $play = document.getElementById("gaudio-play");
  const $playIc = document.getElementById("gaudio-play-ic");
  const $prev = document.getElementById("gaudio-prev");
  const $next = document.getElementById("gaudio-next");
  const $shuffle = document.getElementById("gaudio-shuffle");
  const $shufState = document.getElementById("gaudio-shuf-state");
  const $range = document.getElementById("gaudio-range");
  const $cur = document.getElementById("gaudio-cur");
  const $tot = document.getElementById("gaudio-tot");
  const $listBtn = document.getElementById("gaudio-listBtn");
  const $list = document.getElementById("gaudio-list");
  const $count = document.getElementById("gaudio-count");

  $cover.style.backgroundImage = COVER_URL ? `url("${COVER_URL}")` : "none";

  // =========================
  // PLAYER LOGIC
  // =========================
  const audio = new Audio();
  audio.preload = "metadata";

  // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è/404)
  audio.addEventListener("error", () => {
    const err = audio.error;
    const code = err?.code;
    const msg =
      code === 1 ? "ABORTED" :
      code === 2 ? "NETWORK (404/–¥–æ—Å—Ç—É–ø/–Ω–µ —Å–∫–∞—á–∞–ª–æ—Å—å)" :
      code === 3 ? "DECODE (–∫–æ–¥–µ–∫/–±–∏—Ç—ã–π —Ñ–∞–π–ª)" :
      code === 4 ? "SRC_NOT_SUPPORTED (—Ñ–æ—Ä–º–∞—Ç/–∫–æ–¥–µ–∫)" :
      "UNKNOWN";
    $status.textContent = `Audio error: ${msg}\nURL: ${audio.src || "none"}`;
  });

  let tracks = [];
  let index = 0;
  let isShuffle = false;
  let shuffleBag = [];

  function currentTrack(){ return tracks[index] || null; }

  function renderMeta(){
    const t = currentTrack();
    if(!t){
      $title.textContent = "‚Äî";
      $artist.textContent = T.empty;
      $tot.textContent = "0:00";
      return;
    }
    $title.textContent = t.title || guessNameFromUrl(t.url || "");
    $artist.textContent = t.artist || "";
  }

  function refreshActiveRow(){
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      const i = Number(el.getAttribute("data-i"));
      el.classList.toggle("active", i===index);
    });
  }

  function renderList(){
    $count.textContent = String(tracks.length);
    const rows = tracks.map((t,i)=>{
      const name = t.title || guessNameFromUrl(t.url || "");
      return `
        <div class="track ${i===index ? "active":""}" data-i="${i}">
          <div class="name" title="${name.replaceAll('"','&quot;')}">${name}</div>
        </div>`;
    }).join("");

    $list.innerHTML = `
      <div class="listTitle">
        <span>${T.playlist}</span>
        <span class="badge">${tracks.length}</span>
      </div>
      ${rows}
    `;

    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      el.addEventListener("click", ()=>{
        const i = Number(el.getAttribute("data-i"));
        if(Number.isFinite(i)) loadAndPlay(i, true);
      });
    });
  }

  function load(i){
    if(!tracks.length) return;
    index = (i + tracks.length) % tracks.length;
    const t = currentTrack();
    audio.src = t.url;
    renderMeta();
    refreshActiveRow();
    $status.textContent = "";
  }

  function ensureShuffleBag(){
    const arr = [];
    for(let i=0;i<tracks.length;i++) if(i!==index) arr.push(i);
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    shuffleBag = arr;
  }

  function nextIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      if(shuffleBag.length===0) ensureShuffleBag();
      return shuffleBag.shift();
    }
    return (index+1) % tracks.length;
  }

  function prevIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      let i = Math.floor(Math.random()*tracks.length);
      if(tracks.length>1 && i===index) i = (i+1)%tracks.length;
      return i;
    }
    return (index-1+tracks.length) % tracks.length;
  }

  async function loadAndPlay(i, autoplay){
    load(i);
    if(autoplay){
      try{ await audio.play(); }
      catch(e){ $status.textContent = "play() rejected: " + (e?.name || e); }
      syncPlayUI();
    }
  }

  function syncPlayUI(){
    const playing = !audio.paused;
    $playIc.textContent = playing ? "‚è∏" : "‚ñ∂";
    $play.title = playing ? T.pause : T.play;
    $play.setAttribute("aria-label", playing ? T.pause : T.play);
  }

  $play.addEventListener("click", async ()=>{
    if(!tracks.length) return;
    if(!audio.src) load(index);
    if(audio.paused){
      try{ await audio.play(); }
      catch(e){ $status.textContent = "play() rejected: " + (e?.name || e); }
    }else{
      audio.pause();
    }
    syncPlayUI();
  });

  $next.addEventListener("click", ()=> loadAndPlay(nextIndex(), true));
  $prev.addEventListener("click", ()=> loadAndPlay(prevIndex(), true));

  $shuffle.addEventListener("click", ()=>{
    isShuffle = !isShuffle;
    $shufState.textContent = isShuffle ? "ON" : "OFF";
    $shuffle.title = isShuffle ? T.shuffleOn : T.shuffleOff;
    shuffleBag = [];
    if(isShuffle) ensureShuffleBag();
  });

  $listBtn.addEventListener("click", ()=> $list.classList.toggle("open"));

  $range.addEventListener("input", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = Number($range.value)/1000;
    audio.currentTime = p * audio.duration;
  });

  audio.addEventListener("timeupdate", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = audio.currentTime / audio.duration;
    $range.value = String(Math.round(p*1000));
    setRangeVisual($range, p*100);
    $cur.textContent = fmtTime(audio.currentTime);
  });

  audio.addEventListener("loadedmetadata", ()=> { $tot.textContent = fmtTime(audio.duration); });
  audio.addEventListener("ended", ()=> loadAndPlay(nextIndex(), true));
  audio.addEventListener("play", syncPlayUI);
  audio.addEventListener("pause", syncPlayUI);

  // =========================
  // INIT LOAD from GitHub
  // =========================
  (async () => {
    try{
      $artist.textContent = T.loading;
      $status.textContent = `repo: ${GITHUB_OWNER}/${GITHUB_REPO}\npath: ${GITHUB_PATH || "(root)"}\nref: ${GITHUB_REF}`;

      const res = await loadTracksFromGitHub({
        owner: GITHUB_OWNER,
        repo:  GITHUB_REPO,
        path:  GITHUB_PATH,
        ref:   GITHUB_REF
      });

      tracks = res.tracks;

      if(!tracks.length){
        $artist.textContent = T.empty;
        $status.textContent = `–ü–∞–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ –∞—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\nref=${res.usedRef} path=${res.usedPath}`;
        return;
      }

      $status.textContent = `‚úÖ –¢—Ä–µ–∫–æ–≤: ${tracks.length}\nref=${res.usedRef} path=${res.usedPath}`;
      index = 0;
      renderMeta();
      renderList();
      setRangeVisual($range, 0);
      load(0);
      $artist.textContent = ""; // –æ—á–∏—â–∞–µ–º "loading"
    }catch(e){
      $artist.textContent = T.loadErr;
      $status.textContent = String(e?.message || e);
    }
  })();
})();
</script>
