<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>audiopleer player</title>

  <style>
    :root{
      --p:#7c3aed;
      --a:#f97316;
      --t:#e8eefc;
      --m:#a9b6d6;
    }
    body{margin:0;background:transparent;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #gaudio{width:min(520px,100%);color:var(--t);background:transparent;user-select:none}
    #gaudio .card{
      border-radius:24px;padding:18px 18px 14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,20,34,.38);
      backdrop-filter:blur(10px);
      box-shadow:0 12px 40px rgba(0,0,0,.28);
      overflow:hidden;
    }
    #gaudio .top{display:flex;gap:14px;align-items:center}
    #gaudio .ring{
      width:112px;height:112px;border-radius:999px;position:relative;flex:0 0 auto;
      background:conic-gradient(from 180deg, var(--p), rgba(255,255,255,.10), var(--p));
      padding:6px;
    }
    #gaudio .ring::after{
      content:"";position:absolute;inset:6px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    #gaudio .cover{
      position:absolute;inset:14px;border-radius:999px;
      background-size:cover;background-position:center;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
      z-index:2;
    }
    #gaudio .meta{min-width:0}
    #gaudio .title{
      font-size:14px;font-weight:800;letter-spacing:.2px;line-height:1.2;margin:0;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    #gaudio .artist{
      margin-top:6px;font-size:12px;color:var(--m);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:16px;
    }

    #gaudio .controls{
      display:flex;align-items:center;justify-content:space-between;
      margin-top:14px;gap:10px;
    }
    #gaudio .btn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--t);
      display:grid;place-items:center;cursor:pointer;
    }
    #gaudio .btn:hover{border-color:rgba(255,255,255,.26)}
    #gaudio .btn.primary{
      width:54px;height:54px;border-radius:18px;
      background:rgba(0,0,0,.22);
      border-color:rgba(255,255,255,.18);
      box-shadow:0 12px 28px rgba(0,0,0,.20);
    }
    #gaudio .btn.primary .ic{transform:translateX(1px)}
    #gaudio .btn.tog{
      width:auto;height:40px;padding:0 12px;font-size:12px;color:var(--m);
      gap:8px;display:flex;align-items:center;justify-content:center;
    }
    #gaudio .btn.tog b{color:var(--t);font-weight:800}

    #gaudio .progress{margin-top:14px}
    #gaudio input[type="range"]{
      width:100%;
      -webkit-appearance:none;appearance:none;
      height:6px;border-radius:999px;
      background:linear-gradient(90deg, var(--a) 0%, rgba(255,255,255,.14) 0%);
      outline:none;
    }
    #gaudio input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;
      width:14px;height:14px;border-radius:50%;
      background:var(--a);
      border:1px solid rgba(255,255,255,.25);
      box-shadow:0 8px 20px rgba(0,0,0,.35);
      cursor:pointer;
    }
    #gaudio .time{
      display:flex;justify-content:space-between;
      margin-top:8px;font-size:11px;color:var(--m);
    }

    /* VOLUME */
    #gaudio .volRow{
      margin-top:10px;
      display:flex;align-items:center;gap:10px;
    }
    #gaudio .volIcon{font-size:14px;color:var(--m);width:18px;text-align:center}
    #gaudio .vol{
      flex:1;
    }

    #gaudio .bottom{
      display:flex;align-items:center;justify-content:space-between;
      margin-top:12px;
    }
    #gaudio .listBtn{
      width:auto;height:38px;padding:0 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--m);cursor:pointer;font-size:12px;
    }
    #gaudio .listBtn:hover{border-color:rgba(255,255,255,.24)}
    #gaudio .badge{
      font-size:10px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--m);
    }

    #gaudio .listPanel{
      margin-top:12px;border-top:1px solid rgba(255,255,255,.12);
      padding-top:12px;display:none;
    }
    #gaudio .listPanel.open{display:block}
    #gaudio .listTitle{
      font-size:12px;color:var(--m);
      display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;
    }
    #gaudio .track{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:8px;cursor:pointer;
    }
    #gaudio .track:hover{border-color:rgba(255,255,255,.22)}
    #gaudio .track .name{
      font-size:12px;font-weight:700;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:78%;
    }
    #gaudio .track.active{
      border-color:rgba(255,255,255,.28);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
    }
    #gaudio .statusLine{
      margin-top:10px;font-size:12px;color:var(--m);
      white-space:pre-wrap;line-height:1.35;
    }
  </style>
</head>

<body>
  <div id="gaudio">
    <div class="card">
      <div class="top">
        <div class="ring" aria-hidden="true">
          <div class="cover" id="gaudio-cover"></div>
        </div>
        <div class="meta">
          <p class="title" id="gaudio-title">‚Äî</p>
          <div class="artist" id="gaudio-artist">–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏‚Ä¶</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="gaudio-prev" title="–ù–∞–∑–∞–¥" aria-label="–ù–∞–∑–∞–¥">‚èÆ</button>
        <button class="btn primary" id="gaudio-play" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏">
          <span class="ic" id="gaudio-play-ic">‚ñ∂</span>
        </button>
        <button class="btn" id="gaudio-next" title="–í–ø–µ—Ä—ë–¥" aria-label="–í–ø–µ—Ä—ë–¥">‚è≠</button>
        <button class="btn tog" id="gaudio-shuffle" title="–†–∞–Ω–¥–æ–º: –í–´–ö" aria-label="shuffle">
          üîÄ <b id="gaudio-shuf-state">OFF</b>
        </button>
      </div>

      <div class="progress">
        <input id="gaudio-range" type="range" min="0" max="1000" value="0" />
        <div class="time">
          <span id="gaudio-cur">0:00</span>
          <span id="gaudio-tot">0:00</span>
        </div>
      </div>

      <div class="volRow">
        <div class="volIcon" id="gaudio-vol-ic">üîä</div>
        <input class="vol" id="gaudio-vol" type="range" min="0" max="100" value="85" />
      </div>

      <div class="bottom">
        <button class="listBtn" id="gaudio-listBtn">‚ò∞ –ü–ª–µ–π–ª–∏—Å—Ç</button>
        <span class="badge" id="gaudio-count">0</span>
      </div>

      <div class="listPanel" id="gaudio-list"></div>
      <div class="statusLine" id="gaudio-status"></div>
    </div>
  </div>

<script>
(() => {
  // ‚úÖ repo –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ:
  const GITHUB_OWNER = "onegovakota-cmyk";
  const GITHUB_REPO  = "audiopleer";
  const GITHUB_PATH  = "";      // —Ç—Ä–µ–∫–∏ –≤ –∫–æ—Ä–Ω–µ
  const GITHUB_REF   = "main";  // –µ—Å–ª–∏ –≤–µ—Ç–∫–∞ –¥—Ä—É–≥–∞—è ‚Äî master

  const COVER_URL = "https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800&q=80&auto=format&fit=crop";
  const MAX_TRACKS = 500;
  const audioExt = /\.(mp3|wav|ogg|m4a|aac)$/i;

  const $cover  = document.getElementById("gaudio-cover");
  const $title  = document.getElementById("gaudio-title");
  const $artist = document.getElementById("gaudio-artist");
  const $status = document.getElementById("gaudio-status");

  const $play = document.getElementById("gaudio-play");
  const $playIc = document.getElementById("gaudio-play-ic");
  const $prev = document.getElementById("gaudio-prev");
  const $next = document.getElementById("gaudio-next");
  const $shuffle = document.getElementById("gaudio-shuffle");
  const $shufState = document.getElementById("gaudio-shuf-state");
  const $range = document.getElementById("gaudio-range");
  const $cur = document.getElementById("gaudio-cur");
  const $tot = document.getElementById("gaudio-tot");
  const $listBtn = document.getElementById("gaudio-listBtn");
  const $list = document.getElementById("gaudio-list");
  const $count = document.getElementById("gaudio-count");

  const $vol = document.getElementById("gaudio-vol");
  const $volIc = document.getElementById("gaudio-vol-ic");

  $cover.style.backgroundImage = COVER_URL ? `url("${COVER_URL}")` : "none";

  function fmtTime(s){
    if(!isFinite(s) || s < 0) return "0:00";
    const m = Math.floor(s/60);
    const r = Math.floor(s%60);
    return m + ":" + String(r).padStart(2,"0");
  }

  function setRangeVisual(el, pct){
    const p = Math.max(0, Math.min(100, pct));
    el.style.background = `linear-gradient(90deg, var(--a) ${p}%, rgba(255,255,255,.14) ${p}%)`;
  }

  function guessNameFromUrl(url){
    try{
      const u = new URL(url);
      const file = decodeURIComponent(u.pathname.split("/").pop() || "");
      return file.replace(audioExt,"");
    }catch(e){
      const file = (url.split("/").pop() || "").split("?")[0];
      return decodeURIComponent(file).replace(audioExt,"");
    }
  }

  function contentsUrl(owner, repo, path, ref){
    const cleanPath = (path || "").trim().replace(/^\/+|\/+$/g,"");
    const encodedPath = cleanPath ? cleanPath.split("/").map(encodeURIComponent).join("/") : "";
    return `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodedPath}?ref=${encodeURIComponent(ref)}`;
  }

  async function fetchJson(url){
    const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
    const txt = await res.text().catch(()=> "");
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    return { ok: res.ok, status: res.status, statusText: res.statusText, data, url };
  }

  async function loadTracksFromGitHub(){
    const refsToTry = Array.from(new Set([GITHUB_REF, "main", "master"].map(s=>(s||"").trim()).filter(Boolean)));

    async function walk(items, out){
      for(const x of items){
        if(out.length >= MAX_TRACKS) return;
        if(!x) continue;

        if(x.type === "file" && audioExt.test(x.name || "")){
          out.push({ url: x.download_url, title: (x.name || "").replace(audioExt,"") });
        } else if(x.type === "dir" && x.url){
          const sub = await fetchJson(x.url);
          if(sub.ok && Array.isArray(sub.data)) await walk(sub.data, out);
        }
      }
    }

    let lastErr = null;
    for(const r of refsToTry){
      const url = contentsUrl(GITHUB_OWNER, GITHUB_REPO, GITHUB_PATH, r);
      $status.textContent = `GitHub: ${GITHUB_OWNER}/${GITHUB_REPO}\npath: ${GITHUB_PATH || "(root)"}\nref: ${r}`;

      const res = await fetchJson(url);
      if(!res.ok){ lastErr = res; continue; }
      if(!Array.isArray(res.data)){ lastErr = res; continue; }

      const out = [];
      await walk(res.data, out);
      return { tracks: out, usedRef: r };
    }

    const msg = (lastErr && typeof lastErr.data === "object" && lastErr.data?.message) ? lastErr.data.message : "";
    throw new Error(`GitHub API error: ${lastErr?.status || ""} ${lastErr?.statusText || ""}${msg ? " ‚Äî " + msg : ""}`);
  }

  // ---------------- Player ----------------
  const audio = new Audio();
  audio.preload = "metadata";

  // –ì—Ä–æ–º–∫–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  function setVolUI(v01){
    const v = Math.max(0, Math.min(1, v01));
    audio.volume = v;
    $vol.value = String(Math.round(v*100));
    setRangeVisual($vol, v*100);
    $volIc.textContent = v === 0 ? "üîá" : (v < 0.5 ? "üîâ" : "üîä");
  }
  setVolUI(0.85);

  $vol.addEventListener("input", ()=>{
    const v = Number($vol.value)/100;
    setVolUI(v);
  });

  audio.addEventListener("error", () => {
    const err = audio.error;
    const code = err?.code;
    const msg =
      code === 1 ? "ABORTED" :
      code === 2 ? "NETWORK (404/–¥–æ—Å—Ç—É–ø/–Ω–µ —Å–∫–∞—á–∞–ª–æ—Å—å)" :
      code === 3 ? "DECODE (–∫–æ–¥–µ–∫/–±–∏—Ç—ã–π —Ñ–∞–π–ª)" :
      code === 4 ? "SRC_NOT_SUPPORTED (—Ñ–æ—Ä–º–∞—Ç/–∫–æ–¥–µ–∫)" :
      "UNKNOWN";
    $status.textContent = `Audio error: ${msg}\nURL: ${audio.src || "none"}`;
  });

  let tracks = [];
  let index = 0;
  let isShuffle = false;
  let shuffleBag = [];
  let isSeeking = false;

  function currentTrack(){ return tracks[index] || null; }

  function renderMeta(){
    const t = currentTrack();
    if(!t){
      $title.textContent = "‚Äî";
      $artist.textContent = "–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤";
      $tot.textContent = "0:00";
      return;
    }
    $title.textContent = t.title || guessNameFromUrl(t.url || "");
    $artist.textContent = "";
  }

  function refreshActiveRow(){
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      const i = Number(el.getAttribute("data-i"));
      el.classList.toggle("active", i===index);
    });
  }

  function renderList(){
    $count.textContent = String(tracks.length);
    const rows = tracks.map((t,i)=>{
      const name = t.title || guessNameFromUrl(t.url || "");
      return `
        <div class="track ${i===index ? "active":""}" data-i="${i}">
          <div class="name" title="${name.replaceAll('"','&quot;')}">${name}</div>
        </div>`;
    }).join("");

    $list.innerHTML = `
      <div class="listTitle">
        <span>–ü–ª–µ–π–ª–∏—Å—Ç</span>
        <span class="badge">${tracks.length}</span>
      </div>
      ${rows}
    `;

    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      el.addEventListener("click", ()=>{
        const i = Number(el.getAttribute("data-i"));
        if(Number.isFinite(i)) loadAndPlay(i, true);
      });
    });
  }

  function setProgressByTime(){
    if(!isFinite(audio.duration) || audio.duration <= 0) return;

    const p = audio.currentTime / audio.duration;
    if(!isSeeking){
      $range.value = String(Math.round(p * 1000));
      setRangeVisual($range, p * 100);
    }
    $cur.textContent = fmtTime(audio.currentTime);
  }

  function load(i){
    if(!tracks.length) return;
    index = (i + tracks.length) % tracks.length;
    const t = currentTrack();

    if(!/^https?:\/\//i.test(t.url || "")){
      $status.textContent = "–û—à–∏–±–∫–∞: —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–µ–∫ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://\n" + String(t.url || "");
      return;
    }

    // –°–±—Ä–æ—Å UI –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    $cur.textContent = "0:00";
    $tot.textContent = "0:00";
    $range.value = "0";
    setRangeVisual($range, 0);

    audio.src = t.url;
    renderMeta();
    refreshActiveRow();
  }

  function ensureShuffleBag(){
    const arr = [];
    for(let i=0;i<tracks.length;i++) if(i!==index) arr.push(i);
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    shuffleBag = arr;
  }

  function nextIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      if(shuffleBag.length===0) ensureShuffleBag();
      return shuffleBag.shift();
    }
    return (index+1) % tracks.length;
  }

  function prevIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){
      let i = Math.floor(Math.random()*tracks.length);
      if(tracks.length>1 && i===index) i = (i+1)%tracks.length;
      return i;
    }
    return (index-1+tracks.length) % tracks.length;
  }

  async function loadAndPlay(i, autoplay){
    load(i);
    if(autoplay){
      try{ await audio.play(); }
      catch(e){ $status.textContent = "play() rejected: " + (e?.name || e); }
      syncPlayUI();
    }
  }

  function syncPlayUI(){
    const playing = !audio.paused;
    $playIc.textContent = playing ? "‚è∏" : "‚ñ∂";
    $play.title = playing ? "–ü–∞—É–∑–∞" : "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏";
  }

  // Controls
  $play.addEventListener("click", async ()=>{
    if(!tracks.length) return;
    if(!audio.src) load(index);

    if(audio.paused){
      try{ await audio.play(); }
      catch(e){ $status.textContent = "play() rejected: " + (e?.name || e); }
    }else{
      audio.pause();
    }
    syncPlayUI();
  });

  $next.addEventListener("click", ()=> loadAndPlay(nextIndex(), true));
  $prev.addEventListener("click", ()=> loadAndPlay(prevIndex(), true));

  $shuffle.addEventListener("click", ()=>{
    isShuffle = !isShuffle;
    $shufState.textContent = isShuffle ? "ON" : "OFF";
    $shuffle.title = isShuffle ? "–†–∞–Ω–¥–æ–º: –í–ö–õ" : "–†–∞–Ω–¥–æ–º: –í–´–ö–õ";
    shuffleBag = [];
    if(isShuffle) ensureShuffleBag();
  });

  $listBtn.addEventListener("click", ()=> $list.classList.toggle("open"));

  // Seek: —á—Ç–æ–±—ã –±–µ–≥—É–Ω–æ–∫ –Ω–µ –¥—ë—Ä–≥–∞–ª—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
  $range.addEventListener("pointerdown", ()=> { isSeeking = true; });
  window.addEventListener("pointerup", ()=> { isSeeking = false; });

  $range.addEventListener("input", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = Number($range.value)/1000;
    setRangeVisual($range, p*100);
    $cur.textContent = fmtTime(p * audio.duration);
  });

  $range.addEventListener("change", ()=>{
    if(!isFinite(audio.duration) || audio.duration<=0) return;
    const p = Number($range.value)/1000;
    audio.currentTime = p * audio.duration;
    setProgressByTime();
  });

  // Audio events: –≤–æ—Ç —ç—Ç–æ –∏ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç "–±–µ–∂–∞—Ç—å" –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤—Ä–µ–º—è
  audio.addEventListener("loadedmetadata", ()=>{
    $tot.textContent = fmtTime(audio.duration);
    setProgressByTime();
  });

  audio.addEventListener("durationchange", ()=>{
    if(isFinite(audio.duration) && audio.duration>0) $tot.textContent = fmtTime(audio.duration);
  });

  audio.addEventListener("timeupdate", ()=>{
    setProgressByTime();
  });

  audio.addEventListener("ended", ()=> loadAndPlay(nextIndex(), true));
  audio.addEventListener("play", syncPlayUI);
  audio.addEventListener("pause", syncPlayUI);

  // INIT
  (async () => {
    try{
      const res = await loadTracksFromGitHub();
      tracks = res.tracks;

      if(!tracks.length){
        $artist.textContent = "–í –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ—Ç mp3/wav/ogg/m4a/aac";
        $status.textContent += "\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–º–µ–Ω–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –Ω–µ –∞—Ä—Ö–∏–≤–æ–º.";
        return;
      }

      $status.textContent = `‚úÖ –¢—Ä–µ–∫–æ–≤: ${tracks.length}\nrepo: ${GITHUB_OWNER}/${GITHUB_REPO}\npath: (root)\nref: ${res.usedRef}`;
      renderList();
      load(0);
      $artist.textContent = "";
      setRangeVisual($range, 0);
    }catch(e){
      $artist.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      $status.textContent = String(e?.message || e);
    }
  })();
})();
</script>
</body>
</html>
